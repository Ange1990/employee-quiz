<!DOCTYPE html>
<html lang="el">
<head>
<meta charset="UTF-8">
<title>Î”Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ· Î•ÏÏ‰Ï„Î®ÏƒÎµÏ‰Î½</title>
<style>
  body { font-family: 'Poppins', sans-serif; background: #f0f2f5; padding: 20px; }
  h1 { text-align:center; margin-bottom:20px; color:#333; }
  button { padding:8px 14px; border:none; border-radius:6px; cursor:pointer; font-weight:600; margin:5px; }
  #logout-btn { background:#ff4b2b; color:#fff; }
  #back-btn { background:#007bff; color:#fff; }
  #add-btn { background:#28a745; color:#fff; }
  #save-order-btn { background:#6f42c1; color:#fff; }

  form { background:#fff; padding:20px; border-radius:10px; box-shadow:0 4px 12px rgba(0,0,0,0.1); margin-bottom:20px; max-width:700px; margin-left:auto; margin-right:auto; }
  input, select, textarea { width:100%; padding:8px; margin:8px 0; border:1px solid #ccc; border-radius:6px; }

  #options-container .option-row { display:flex; gap:10px; align-items:center; margin-bottom:5px; }
  .option-input { flex:1; }
  .remove-option-btn { background:#dc3545; color:#fff; border:none; border-radius:5px; cursor:pointer; padding:4px 8px; }

  .question-card { background:#fff; padding:15px; margin-bottom:12px; border-radius:10px; box-shadow:0 4px 10px rgba(0,0,0,0.1); max-width:700px; margin-left:auto; margin-right:auto; cursor:grab; display:flex; align-items:center; justify-content:space-between; gap:10px; }
  .question-text { flex:1; word-break:break-word; }
  .question-type { font-weight:600; color:#555; min-width:80px; }
  .question-order { font-weight:600; color:#333; min-width:70px; text-align:center; }
  .action-btn { padding:6px 10px; border:none; border-radius:6px; font-weight:600; cursor:pointer; }
  .edit-btn { background:#ffc107; color:#fff; }
  .delete-btn { background:#dc3545; color:#fff; }
</style>
</head>
<body>

<button id="back-btn">â¬… Î•Ï€Î¹ÏƒÏ„ÏÎ¿Ï†Î® ÏƒÏ„Î¿ Dashboard</button>
<button id="logout-btn">Î‘Ï€Î¿ÏƒÏÎ½Î´ÎµÏƒÎ·</button>
<h1>Î”Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ· Î•ÏÏ‰Ï„Î®ÏƒÎµÏ‰Î½</h1>

<form id="question-form">
  <label for="question-text">ÎšÎµÎ¯Î¼ÎµÎ½Î¿ Î•ÏÏÏ„Î·ÏƒÎ·Ï‚:</label>
  <textarea id="question-text" required></textarea>

  <label for="question-type">Î¤ÏÏ€Î¿Ï‚ Î•ÏÏÏ„Î·ÏƒÎ·Ï‚:</label>
  <select id="question-type">
    <option value="open">Î‘Î½Î¿Î¹ÎºÏ„Î® (Î±Î½Î±Ï€Ï„Ï…Î¾Î¹Î±ÎºÎ®)</option>
    <option value="scale-stars">Scale-stars (Î±ÏƒÏ„ÎµÏÎ¬ÎºÎ¹Î±)</option>
    <option value="multiple">Î Î¿Î»Î»Î±Ï€Î»Î®Ï‚ Î•Ï€Î¹Î»Î¿Î³Î®Ï‚</option>
  </select>

  <label id="options-label" style="display:none;">Î•Ï€Î¹Î»Î¿Î³Î­Ï‚:</label>
  <div id="options-container" style="display:none;"></div>
  <button type="button" id="add-option-btn" style="display:none;">â• Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· Î•Ï€Î¹Î»Î¿Î³Î®Ï‚</button>

  <label for="question-group">ÎŸÎ¼Î¬Î´Î± Î•ÏÏÏ„Î·ÏƒÎ·Ï‚ (Ï€ÏÎ¿Î±Î¹ÏÎµÏ„Î¹ÎºÎ¬):</label>
  <input type="text" id="question-group" placeholder="Î‘Ï†Î®ÏƒÏ„Îµ ÎºÎµÎ½ÏŒ Î³Î¹Î± ÏŒÎ»ÎµÏ‚ Ï„Î¹Ï‚ Î¿Î¼Î¬Î´ÎµÏ‚">

  <button type="submit" id="add-btn">Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· Î•ÏÏÏ„Î·ÏƒÎ·Ï‚</button>
</form>

<button id="save-order-btn">Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ· Î£ÎµÎ¹ÏÎ¬Ï‚</button>
<div id="questions-container"></div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="js/firebase-config.js"></script>

<script>
// --- DOM elements ---
const form = document.getElementById("question-form");
const textInput = document.getElementById("question-text");
const typeSelect = document.getElementById("question-type");
const groupInput = document.getElementById("question-group");
const questionsContainer = document.getElementById("questions-container");
const logoutBtn = document.getElementById("logout-btn");
const backBtn = document.getElementById("back-btn");
const saveOrderBtn = document.getElementById("save-order-btn");
const optionsContainer = document.getElementById("options-container");
const addOptionBtn = document.getElementById("add-option-btn");
const optionsLabel = document.getElementById("options-label");

let editId = null;

// --- ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ CEO ---
auth.onAuthStateChanged(user => {
  if (!user) {
    // Î‘Î½ Î´ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ ÏƒÏ…Î½Î´ÎµÎ´ÎµÎ¼Î­Î½Î¿Ï‚ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚ â†’ ÎµÏ€Î¹ÏƒÏ„ÏÎ¿Ï†Î® ÏƒÏ„Î· login ÏƒÎµÎ»Î¯Î´Î±
    window.location.href = "index.html";
  } else {
    // Î›Î¯ÏƒÏ„Î± Î¼Îµ ÏŒÎ»Î± Ï„Î± emails Ï„Ï‰Î½ CEO
    const ceoEmails = [
      "nafpliotis@sspc.gr",
      "tzanetopoulou@sspc.gr",   // ğŸ”¹ Î´ÎµÏÏ„ÎµÏÎ¿Ï‚ CEO
      "nafpliotou@sspc.gr"    // ğŸ”¹ Ï„ÏÎ¯Ï„Î¿Ï‚ CEO
    ];

    // ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Î±Î½ Ï„Î¿ email Ï„Î¿Ï… Ï‡ÏÎ®ÏƒÏ„Î· ÎµÎ¯Î½Î±Î¹ Î¼Î­ÏƒÎ± ÏƒÏ„Î· Î»Î¯ÏƒÏ„Î±
    if (!ceoEmails.includes(user.email.toLowerCase())) {
      alert("Î”ÎµÎ½ Î­Ï‡ÎµÏ„Îµ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· ÏƒÎµ Î±Ï…Ï„Î® Ï„Î· ÏƒÎµÎ»Î¯Î´Î±.");
      window.location.href = "index.html";
    } else {
      // Î‘Î½ ÎµÎ¯Î½Î±Î¹ CEO â†’ ÏƒÏ…Î½Î­Ï‡Î¹ÏƒÎµ ÎºÎ±Î½Î¿Î½Î¹ÎºÎ¬
      loadQuestions();
    }
  }
});

logoutBtn.addEventListener("click", () => auth.signOut().then(() => window.location.href="index.html"));
backBtn.addEventListener("click", () => window.location.href="dashboard.html");

// --- Multiple choice ÎµÏ€Î¹Î»Î¿Î³Î­Ï‚ ---
typeSelect.addEventListener("change", () => {
  if(typeSelect.value === "multiple"){
    optionsLabel.style.display = "block";
    optionsContainer.style.display = "block";
    addOptionBtn.style.display = "inline-block";
    if(optionsContainer.children.length === 0) addOptionField();
  } else {
    optionsLabel.style.display = "none";
    optionsContainer.style.display = "none";
    addOptionBtn.style.display = "none";
    optionsContainer.innerHTML = "";
  }
});

addOptionBtn.addEventListener("click", () => addOptionField());
function addOptionField(value = "") {
  const row = document.createElement("div");
  row.className = "option-row";
  const input = document.createElement("input");
  input.type = "text";
  input.className = "option-input";
  input.placeholder = `Î ÎµÏÎ¹ÎµÏ‡ÏŒÎ¼ÎµÎ½Î¿ ÎµÏ€Î¹Î»Î¿Î³Î®Ï‚ ${String.fromCharCode(65 + optionsContainer.children.length)}`;
  input.value = value;

  const removeBtn = document.createElement("button");
  removeBtn.type = "button";
  removeBtn.className = "remove-option-btn";
  removeBtn.textContent = "âŒ";
  removeBtn.addEventListener("click", () => row.remove());

  row.appendChild(input);
  row.appendChild(removeBtn);
  optionsContainer.appendChild(row);
}

// --- Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ·/Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î± ---
form.addEventListener("submit", e => {
  e.preventDefault();
  const text = textInput.value.trim();
  const type = typeSelect.value;
  const groupVal = groupInput.value.trim();
  let group = null;
  if(groupVal !== ""){
    const g = parseInt(groupVal);
    if(!isNaN(g)) group = g;
  }

  let options = [];
  if(type === "multiple"){
    optionsContainer.querySelectorAll(".option-input").forEach(inp => {
      if(inp.value.trim()) options.push(inp.value.trim());
    });
    if(options.length === 0) return alert("Î ÏÎ­Ï€ÎµÎ¹ Î½Î± Î´ÏÏƒÎµÎ¹Ï‚ Ï„Î¿Ï…Î»Î¬Ï‡Î¹ÏƒÏ„Î¿Î½ Î¼Î¯Î± ÎµÏ€Î¹Î»Î¿Î³Î®.");
  }

  db.collection("questions").orderBy("order","desc").limit(1).get()
    .then(snapshot => {
      let maxOrder = 0;
      snapshot.forEach(doc => { maxOrder = Number(doc.data().order) || 0; });

      const questionData = { text, type, order: maxOrder + 1 };
      if(options.length > 0) questionData.options = options;
      if(group !== null) questionData.group = group; // Ï€ÏÎ¿ÏƒÎ¸Î®ÎºÎ· Î¼ÏŒÎ½Î¿ Î±Î½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ Î±ÏÎ¹Î¸Î¼ÏŒÏ‚

      if(editId){
        // Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î±: Î±Î½ group ÎµÎ¯Î½Î±Î¹ null, Î´Î¹Î±Î³ÏÎ¬Ï†ÎµÏ„Î±Î¹
        const updateData = { text, type };
        if(options.length > 0) updateData.options = options;
        if(group !== null) updateData.group = group;
        else updateData.group = firebase.firestore.FieldValue.delete();

        return db.collection("questions").doc(editId).update(updateData).then(() => editId=null);
      } else {
        return db.collection("questions").add(questionData);
      }
    })
    .then(() => { form.reset(); optionsContainer.innerHTML = ""; loadQuestions(); })
    .catch(err => console.error("Write failed:", err));
});

// --- Î¦ÏŒÏÏ„Ï‰ÏƒÎ· ÎµÏÏ‰Ï„Î®ÏƒÎµÏ‰Î½ ---
function loadQuestions(){
  db.collection("questions").orderBy("order").get()
    .then(snapshot => {
      questionsContainer.innerHTML = "";
      snapshot.docs.forEach(doc => {
        const data = doc.data();
        const card = document.createElement("div");
        card.className = "question-card";
        card.draggable = true;
        card.dataset.id = doc.id;
        card.dataset.order = data.order;

        const textDiv = document.createElement("div");
        textDiv.className = "question-text";
        textDiv.textContent = data.text;

        const typeDiv = document.createElement("div");
        typeDiv.className = "question-type";
        typeDiv.textContent = data.type === "open" ? "Î‘Î½Î¿Î¹ÎºÏ„Î®" : data.type === "scale-stars" ? "Î‘ÏƒÏ„ÎµÏÎ¬ÎºÎ¹Î±" : "Î Î¿Î»Î»Î±Ï€Î»Î®Ï‚ Î•Ï€Î¹Î»Î¿Î³Î®Ï‚";

        const orderSpan = document.createElement("span");
        orderSpan.className = "question-order";
        orderSpan.textContent = `Î£ÎµÎ¹ÏÎ¬: ${data.order} | ÎŸÎ¼Î¬Î´Î±: ${data.group !== undefined ? data.group : "ÎŒÎ»ÎµÏ‚"}`;

        const editBtn = document.createElement("button");
        editBtn.className = "action-btn edit-btn";
        editBtn.textContent = "Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î±";
        editBtn.addEventListener("click", () => {
          textInput.value = data.text;
          typeSelect.value = data.type;
          groupInput.value = data.group !== undefined ? data.group : "";
          optionsContainer.innerHTML = "";
          if(data.type==="multiple" && data.options) data.options.forEach(opt => addOptionField(opt));
          typeSelect.dispatchEvent(new Event("change"));
          editId = doc.id;
        });

        const delBtn = document.createElement("button");
        delBtn.className = "action-btn delete-btn";
        delBtn.textContent = "Î”Î¹Î±Î³ÏÎ±Ï†Î®";
        delBtn.addEventListener("click", () => {
          if(confirm("ÎÎ± Î´Î¹Î±Î³ÏÎ±Ï†ÎµÎ¯ Î· ÎµÏÏÏ„Î·ÏƒÎ·;")) db.collection("questions").doc(doc.id).delete().then(() => loadQuestions());
        });

        card.appendChild(textDiv);
        card.appendChild(typeDiv);
        card.appendChild(editBtn);
        card.appendChild(delBtn);
        card.appendChild(orderSpan);
        questionsContainer.appendChild(card);
      });
      enableDragDrop();
    });
}

// --- Drag & Drop ---
function enableDragDrop(){
  let dragSrcEl = null;
  const cards = questionsContainer.querySelectorAll(".question-card");
  cards.forEach(card => {
    card.addEventListener("dragstart", e => { dragSrcEl = card; e.dataTransfer.effectAllowed="move"; });
    card.addEventListener("dragover", e => { e.preventDefault(); e.dataTransfer.dropEffect="move"; });
    card.addEventListener("drop", e => {
      e.stopPropagation();
      if(dragSrcEl !== card){
        let nodes = Array.from(questionsContainer.children);
        let srcIndex = nodes.indexOf(dragSrcEl);
        let tgtIndex = nodes.indexOf(card);
        if(srcIndex < tgtIndex) card.after(dragSrcEl);
        else card.before(dragSrcEl);
      }
    });
  });
}

// --- Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ· ÏƒÎµÎ¹ÏÎ¬Ï‚ ---
saveOrderBtn.addEventListener("click", () => {
  const cards = questionsContainer.querySelectorAll(".question-card");
  cards.forEach((card, i) => {
    const id = card.dataset.id;
    card.dataset.order = i + 1;
    const currentGroup = card.querySelector(".question-order").textContent.split("|")[1].trim();
    card.querySelector(".question-order").textContent = `Î£ÎµÎ¹ÏÎ¬: ${i+1} | ${currentGroup}`;
    db.collection("questions").doc(id).update({ order: i + 1 });
  });
  alert("Î— ÏƒÎµÎ¹ÏÎ¬ Î±Ï€Î¿Î¸Î·ÎºÎµÏÏ„Î·ÎºÎµ!");
});
</script>

</body>
</html>

