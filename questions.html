<!DOCTYPE html>
<html lang="el">
<head>
<meta charset="UTF-8">
<title>Διαχείριση Ερωτήσεων</title>
<style>
  body { font-family: 'Poppins', sans-serif; background: #f0f2f5; padding: 20px; }
  h1 { text-align:center; margin-bottom:20px; color:#333; }
  button { padding:8px 14px; border:none; border-radius:6px; cursor:pointer; font-weight:600; margin:5px; }
  #logout-btn { background:#ff4b2b; color:#fff; }
  #logout-btn:hover { background:#ff6a4d; }
  #back-btn { background:#007bff; color:#fff; }
  #back-btn:hover { background:#0056b3; }
  #add-btn { background:#28a745; color:#fff; }
  #add-btn:hover { background:#218838; }
  #save-order-btn { background:#6f42c1; color:#fff; }
  #save-order-btn:hover { background:#5a32a3; }

  form { background:#fff; padding:20px; border-radius:10px; box-shadow:0 4px 12px rgba(0,0,0,0.1); margin-bottom:20px; max-width:700px; margin-left:auto; margin-right:auto; }
  input, select, textarea { width:100%; padding:8px; margin:8px 0; border:1px solid #ccc; border-radius:6px; }
  .question-card { background:#fff; padding:15px; margin-bottom:12px; border-radius:10px; box-shadow:0 4px 10px rgba(0,0,0,0.1); max-width:700px; margin-left:auto; margin-right:auto; cursor:grab; display:flex; justify-content:space-between; align-items:center; }
  .question-text { flex:1; margin-right:10px; word-break:break-word; }
  .question-type { font-weight:600; color:#555; margin-right:10px; }
  .options-list { margin-top:8px; padding-left:20px; font-size:14px; }
  .delete-btn { background:#dc3545; color:#fff; }
  .delete-btn:hover { background:#c82333; }
</style>
</head>
<body>

<button id="back-btn">⬅ Επιστροφή στο Dashboard</button>
<button id="logout-btn">Αποσύνδεση</button>
<h1>Διαχείριση Ερωτήσεων</h1>

<form id="question-form">
  <label for="question-text">Κείμενο Ερώτησης:</label>
  <textarea id="question-text" required></textarea>

  <label for="question-type">Τύπος Ερώτησης:</label>
  <select id="question-type">
    <option value="open">Ανοικτή (αναπτυξιακή)</option>
    <option value="scale-stars">Scale-stars (αστεράκια)</option>
  </select>

  <button type="submit" id="add-btn">Προσθήκη Ερώτησης</button>
</form>

<button id="save-order-btn">Αποθήκευση Σειράς</button>

<div id="questions-container"></div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyD_MPxHrzLs2vd677t3Nr8vXKFtQEuLI2g",
  authDomain: "quiz-aa480.firebaseapp.com",
  projectId: "quiz-aa480",
  storageBucket: "quiz-aa480.appspot.com",
  messagingSenderId: "913659290274",
  appId: "1:913659290274:web:412b6ca878f15d094f6dfb",
  measurementId: "G-Q3X66T9MJF"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// DOM
const form = document.getElementById("question-form");
const textInput = document.getElementById("question-text");
const typeSelect = document.getElementById("question-type");
const questionsContainer = document.getElementById("questions-container");
const logoutBtn = document.getElementById("logout-btn");
const backBtn = document.getElementById("back-btn");
const saveOrderBtn = document.getElementById("save-order-btn");

// Έλεγχος CEO
auth.onAuthStateChanged(user=>{
  if(!user) window.location.href="index.html";
  else if(user.email!=="nafpliotis@sspc.gr") { alert("Δεν έχετε πρόσβαση"); window.location.href="index.html"; }
  else loadQuestions();
});

// Logout
logoutBtn.addEventListener("click", ()=>auth.signOut().then(()=>window.location.href="index.html"));
backBtn.addEventListener("click", ()=>window.location.href="dashboard.html");

// Προσθήκη ερώτησης
form.addEventListener("submit", e=>{
  e.preventDefault();
  const text = textInput.value.trim();
  const type = typeSelect.value;
  if(!text) return alert("Πληκτρολόγησε κείμενο.");

  // Βρες μεγαλύτερο order και πρόσθεσε +1
  db.collection("questions").orderBy("order","desc").limit(1).get()
    .then(snapshot=>{
      let maxOrder = 0;
      snapshot.forEach(doc=>{ maxOrder = doc.data().order || 0; });
      const questionData = { text, type, order: maxOrder+1 };
      return db.collection("questions").add(questionData);
    })
    .then(()=>{ form.reset(); loadQuestions(); })
    .catch(err=>console.error(err));
});

// Φόρτωση ερωτήσεων
function loadQuestions(){
  db.collection("questions").orderBy("order").get()
    .then(snapshot=>{
      questionsContainer.innerHTML="";
      snapshot.docs.forEach(doc=>{
        const data = doc.data();
        const card = document.createElement("div");
        card.className="question-card";
        card.draggable = true;
        card.dataset.id = doc.id;
        card.dataset.order = data.order;

        const textDiv = document.createElement("div");
        textDiv.className="question-text";
        textDiv.innerHTML = `${data.text} <br><small>Σειρά: ${data.order}</small>`;
        const typeDiv = document.createElement("div");
        typeDiv.className="question-type";
        typeDiv.textContent = data.type==="open"?"Ανοικτή":"Αστεράκια";

        const delBtn = document.createElement("button");
        delBtn.className="delete-btn";
        delBtn.textContent="Διαγραφή";
        delBtn.addEventListener("click", ()=>{
          if(confirm("Να διαγραφεί η ερώτηση;")){
            db.collection("questions").doc(doc.id).delete().then(()=>loadQuestions());
          }
        });

        card.appendChild(textDiv);
        card.appendChild(typeDiv);
        card.appendChild(delBtn);
        questionsContainer.appendChild(card);
      });
      enableDragDrop();
    });
}

// Drag & Drop
function enableDragDrop(){
  let dragSrcEl = null;
  const cards = questionsContainer.querySelectorAll(".question-card");
  cards.forEach(card=>{
    card.addEventListener("dragstart", e=>{ dragSrcEl = card; e.dataTransfer.effectAllowed="move"; });
    card.addEventListener("dragover", e=>{ e.preventDefault(); e.dataTransfer.dropEffect="move"; });
    card.addEventListener("drop", e=>{
      e.stopPropagation();
      if(dragSrcEl !== card){
        let nodes = Array.from(questionsContainer.children);
        let srcIndex = nodes.indexOf(dragSrcEl);
        let tgtIndex = nodes.indexOf(card);
        if(srcIndex < tgtIndex) card.after(dragSrcEl);
        else card.before(dragSrcEl);
      }
    });
  });
}

// Αποθήκευση σειράς
saveOrderBtn.addEventListener("click", ()=>{
  const cards = questionsContainer.querySelectorAll(".question-card");
  cards.forEach((card,i)=>{
    const id = card.dataset.id;
    card.dataset.order = i+1;
    const textDiv = card.querySelector(".question-text");
    textDiv.innerHTML = `${textDiv.textContent.split("Σειρά:")[0].trim()} <br><small>Σειρά: ${i+1}</small>`;
    db.collection("questions").doc(id).update({ order:i+1 });
  });
  alert("Η σειρά αποθηκεύτηκε!");
});
</script>
</body>
</html>
